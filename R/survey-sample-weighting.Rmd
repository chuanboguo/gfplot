---
title: "Survey sample weighting"
output: html_document
---

```{r, eval=TRUE, echo=FALSE}
knitr::opts_knit$set(root.dir = '..')
ggplot2::theme_set(ggsidekick::theme_sleek())
```

Let's use pacific ocean perch and the Queen Charlotte Sound Synoptic Survey as an example:

Read in the various data frames we need. These are all created with functions (and a single wrapper function) in `R/get-dat.R`.

```{r, message=FALSE, warning=FALSE}
source("R/weight-props.R")
library(dplyr)
library(ggplot2)

survey_specimens <- readRDS("data-cache/all-survey-bio.rds") %>%
  filter(species_common_name %in% "pacific ocean perch") %>%
  filter(survey_series_id %in% 1)
survey_specimens_age <- survey_specimens %>% filter(!is.na(age))
survey_specimens_length <- survey_specimens %>% filter(!is.na(length))

survey_tows <- readRDS("data-cache/all-survey-spatial-tows.rds") %>%
  filter(species_common_name %in% "pacific ocean perch") %>%
  filter(survey_series_id %in% 1)

sample_trip_ids <- readRDS("data-cache/sample-trip-id-lookup.rds")

areas <- readRDS("data-cache/stratum-areas.rds")
```

Combine the strata data frames: 

```{r}
strata_dat <- left_join(survey_tows, sample_trip_ids, by = "fishing_event_id") %>%
  select(year, survey_id, fishing_event_id, sample_id, grouping_code, density_kgpm2)
strata_dat <- left_join(strata_dat, areas, by = c("survey_id", "grouping_code"))
head(strata_dat)
```

The magic happens here with these functions. The first combines the composition data with information on average species density per stratum and the area of the strata. The second does the re-weighting.

For surveys, the proportions are first weighted by the density of the tow associated with the sample compared to the species density in the strata and secondly by the strata area compared to the total area for the survey.

```{r, comment=NA,echo=TRUE,code=readLines("weight-props.R")}
```

Which we execute on our data with:

```{r}
comp <- join_comps_strata(survey_specimens_age, strata_dat) %>% 
  weight_comps()
head(comp)
```

Make sure the proportions add up to 1 each year: 

```{r}
a1 <- group_by(comp, year) %>%
  summarise(total = sum(weighted_age_prop)) %>% round(9)
assertthat::assert_that(all(a1$total == 1))
```

Plots of the output comparing the raw proportions to the weighted proportions:

```{r}
raw <- survey_specimens %>%
  select(year, age, weight) %>%
  filter(!is.na(age)) %>%
  group_by(year, age) %>%
  summarise(freq = n()) %>%
  group_by(year) %>%
  mutate(raw_age_prop = freq / sum(freq)) %>%
  select(-freq) %>%
  left_join(comp, by = c("year", "age")) %>%
  filter(!is.na(weighted_age_prop))

tidyr::gather(raw, proportion_type, age_prop, -age, -year) %>%
  ggplot(aes(year, age, size = age_prop)) +
  geom_point(alpha = 0.8, pch = 21) + scale_size(range = c(0.2, 8)) +
  facet_wrap(~proportion_type) +
  scale_x_continuous(breaks = seq(min(raw$year), max(raw$year), 2))

tidyr::gather(raw, proportion_type, age_prop, -age, -year) %>%
  ggplot(aes(year, age, size = age_prop)) +
  geom_point(alpha = 0.8, pch = 21, aes(colour = proportion_type),
    position = position_dodge(width = 0.5)) + 
  scale_size(range = c(0.1, 10)) +
  scale_x_continuous(breaks = seq(min(raw$year), max(raw$year), 2))

tidyr::gather(raw, proportion_type, age_prop, -age, -year) %>%
  ggplot(aes(year, age, size = age_prop)) +
  geom_point(alpha = 0.8, pch = 21, aes(colour = proportion_type)) + 
  scale_size(range = c(0.1, 10)) +
  scale_x_continuous(breaks = seq(min(raw$year), max(raw$year), 2))
```

Plot the difference between the 2 as ratios:

```{r}
ggplot(raw, aes(year, age, colour = weighted_age_prop / raw_age_prop,
  size = abs(log(weighted_age_prop / raw_age_prop)))) +
  geom_point(pch = 21) +
  scale_size(range = c(0.2, 8)) +
  scale_color_gradient2(midpoint = 1.0) +
  scale_x_continuous(breaks = seq(min(raw$year), max(raw$year), 2))
```

Plot the difference between the 2 as the weighted portions minus the raw proportions:

```{r}
ggplot(raw, aes(year, age, colour = weighted_age_prop - raw_age_prop)) +
  geom_point(pch = 20, size = 2) +
  scale_color_gradient2(midpoint = 0) +
  scale_x_continuous(breaks = seq(min(raw$year), max(raw$year), 2))
```

# Length

Now the lengths (the functions will be cleaned up to make this easier):

```{r}
bin_size <- 2
length_bins <- seq(min(survey_specimens_length$length), 
  max(survey_specimens_length$length), bin_size)

comp_length_raw <- survey_specimens_length %>%
  mutate(bin = length_bins[findInterval(length, length_bins)] + bin_size / 2)

comp_length <- comp_length_raw %>%
  select(-age) %>% rename(age = bin) %>% 
  join_comps_strata(strata_dat) %>% 
  weight_comps() %>% 
  rename(weighted_length_prop = weighted_age_prop, bin = age)
```

Plot it:

```{r}
comp_length_raw <- comp_length_raw %>%
  select(year, bin, weight) %>%
  group_by(year, bin) %>%
  summarise(freq = n()) %>%
  group_by(year) %>%
  mutate(raw_length_prop = freq / sum(freq)) %>%
  select(-freq) %>%
  left_join(comp_length, by = c("year", "bin")) %>%
  filter(!is.na(weighted_length_prop))

tidyr::gather(comp_length_raw, proportion_type, length_prop, -bin, -year) %>%
  ggplot(aes(year, bin, size = length_prop)) +
  geom_point(alpha = 0.8, pch = 21, aes(colour = proportion_type)) + 
  scale_size(range = c(0.1, 10)) +
  scale_x_continuous(breaks = seq(min(raw$year), max(raw$year), 2))
```

Probably easier to look at histograms:

```{r}
tidyr::gather(comp_length_raw, proportion_type, length_prop, -bin, -year) %>%
  ggplot(aes(bin, length_prop)) +
  geom_col(aes(fill = proportion_type), position = position_dodge(width = 1.9)) +
  facet_wrap(~year) + xlab("Length bin")
```

