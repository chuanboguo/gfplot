<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fit a von Bertalanffy growth model — fit_vb • gfplot</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Fit a von Bertalanffy growth model — fit_vb" />

<meta property="og:description" content="For use with data for a single species." />
<meta name="twitter:card" content="summary" />


<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gfplot</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/commercial-cpue-index.html">Commercial CPUE</a>
    </li>
  </ul>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/pbs-assess/gfplot">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fit a von Bertalanffy growth model</h1>
    <small class="dont-index">Source: <a href='https://github.com/pbs-assess/gfplot/blob/master/R/growth.R'><code>R/growth.R</code></a></small>
    <div class="hidden name"><code>fit_vb.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>For use with data for a single species.</p>
    
    </div>

    <pre class="usage"><span class='fu'>fit_vb</span>(<span class='no'>dat</span>, <span class='kw'>sex</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='st'>"female"</span>, <span class='st'>"male"</span>), <span class='kw'>method</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='st'>"mpd"</span>, <span class='st'>"mcmc"</span>),
  <span class='kw'>downsample</span> <span class='kw'>=</span> <span class='fl'>Inf</span>, <span class='kw'>chains</span> <span class='kw'>=</span> <span class='fl'>4L</span>, <span class='kw'>iter</span> <span class='kw'>=</span> <span class='fl'>1000L</span>,
  <span class='kw'>cores</span> <span class='kw'>=</span> <span class='kw pkg'>parallel</span><span class='kw ns'>::</span><span class='fu'><a href='http://www.rdocumentation.org/packages/parallel/topics/detectCores'>detectCores</a></span>(), <span class='kw'>allow_slow_mcmc</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>est_method</span> <span class='kw'>=</span> <span class='no'>median</span>, <span class='kw'>min_samples</span> <span class='kw'>=</span> <span class='fl'>50L</span>, <span class='kw'>too_high_quantile</span> <span class='kw'>=</span> <span class='fl'>1</span>,
  <span class='kw'>uniform_priors</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>ageing_method_codes</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='no'>...</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>dat</th>
      <td><p>Input data frame. Should be from <code><a href='get.html'>get_survey_samples()</a></code> or
<code><a href='get.html'>get_comm_samples()</a></code>.</p></td>
    </tr>
    <tr>
      <th>sex</th>
      <td><p>Either "male" or "female".</p></td>
    </tr>
    <tr>
      <th>method</th>
      <td><p><code>"mpd"</code> for the mode of the posterior distribution (with
<code><a href='http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-optimizing'>rstan::optimizing()</a></code>) or <code>"mcmc"</code> for full MCMC sampling with Stan (with
<code><a href='http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling'>rstan::sampling()</a></code>).</p></td>
    </tr>
    <tr>
      <th>downsample</th>
      <td><p>If not <code>Inf</code> this represents a number of fish specimens to
sample prior to model fitting. Can be useful for large data sets that you
want to fit with MCMC for testing purposes.</p></td>
    </tr>
    <tr>
      <th>chains</th>
      <td><p>Number of Stan chains.</p></td>
    </tr>
    <tr>
      <th>iter</th>
      <td><p>Number of Stan sampling iterations.</p></td>
    </tr>
    <tr>
      <th>cores</th>
      <td><p>Number of cores for Stan.</p></td>
    </tr>
    <tr>
      <th>allow_slow_mcmc</th>
      <td><p>Logical. If <code>TRUE</code> then the function will let you fit
with MCMC to any number of fish. Defaults to <code>FALSE</code> to avoid accidentally
fitting a model to a giant data set (stop if number of fish &gt; 50,000).</p></td>
    </tr>
    <tr>
      <th>est_method</th>
      <td><p>If MCMC this defines how to summarize the posterior. Should
be a function such as <code>mean</code> or <code>median</code>.</p></td>
    </tr>
    <tr>
      <th>min_samples</th>
      <td><p>The minimum number of fish before a model will be fit.</p></td>
    </tr>
    <tr>
      <th>too_high_quantile</th>
      <td><p>A quantile above which to discard weights and
lengths. Can be useful for outliers. Defaults to including all data.</p></td>
    </tr>
    <tr>
      <th>uniform_priors</th>
      <td><p>Logical. If true then uniform priors will be used.</p></td>
    </tr>
    <tr>
      <th>ageing_method_codes</th>
      <td><p>A numeric vector of ageing method codes to filter
on. Defaults to <code>NULL</code>, which brings in all valid ageing codes. See
<code><a href='get.html'>get_age_methods()</a></code>.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Any other arguments to pass on to <code><a href='http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling'>rstan::sampling()</a></code> or
<code><a href='http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-optimizing'>rstan::optimizing()</a></code>.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Note that in some cases you must load the rstan package first and
you may choose to do so just in case. If the rstan package is not loaded
first, you may get the warning:</p>
<p><code>Error in cpp_object_initializer(.self, .refClassDef, ...) :</code>
<code>could not find function "cpp_object_initializer"</code></p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>Other growth functions: <code><a href='fit_length_weight.html'>fit_length_weight</a></code>,
  <code><a href='plot_growth.html'>plot_growth</a></code></p></div>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='fu'>library</span>(<span class='no'>rstan</span>) <span class='co'># must load first</span>
<span class='co'># with `rstan::optimizing()` for the mode of the posterior density:</span>
<span class='no'>model_f</span> <span class='kw'>&lt;-</span> <span class='fu'>fit_vb</span>(<span class='no'>pop_samples</span>, <span class='kw'>sex</span> <span class='kw'>=</span> <span class='st'>"female"</span>)</div><div class='output co'>#&gt; Initial log joint probability = 2276.95
#&gt; Optimization terminated normally: 
#&gt;   Convergence detected: relative gradient magnitude is below tolerance</div><div class='input'><span class='no'>model_m</span> <span class='kw'>&lt;-</span> <span class='fu'>fit_vb</span>(<span class='no'>pop_samples</span>, <span class='kw'>sex</span> <span class='kw'>=</span> <span class='st'>"male"</span>)</div><div class='output co'>#&gt; Initial log joint probability = 3009.6
#&gt; Optimization terminated normally: 
#&gt;   Convergence detected: relative gradient magnitude is below tolerance</div><div class='input'><span class='fu'><a href='plot_growth.html'>plot_vb</a></span>(<span class='no'>model_f</span>, <span class='no'>model_m</span>)</div><div class='img'><img src='fit_vb-1.png' alt='' width='700' height='433' /></div><div class='input'><span class='no'>model_f</span>$<span class='no'>model</span></div><div class='output co'>#&gt; $par
#&gt;           k        linf       sigma          t0 
#&gt;  0.16292348 43.42801222  0.07106321 -0.63766600 
#&gt; 
#&gt; $value
#&gt; [1] 3096.104
#&gt; 
#&gt; $return_code
#&gt; [1] 0
#&gt; </div><div class='input'><span class='no'>model_f</span>$<span class='no'>predictions</span></div><div class='output co'>#&gt; # A tibble: 200 x 2
#&gt;      age length
#&gt;    &lt;dbl&gt;  &lt;dbl&gt;
#&gt;  1  2      15.2
#&gt;  2  2.35   16.7
#&gt;  3  2.70   18.2
#&gt;  4  3.06   19.6
#&gt;  5  3.41   21.0
#&gt;  6  3.76   22.2
#&gt;  7  4.11   23.4
#&gt;  8  4.46   24.5
#&gt;  9  4.81   25.6
#&gt; 10  5.17   26.6
#&gt; # ... with 190 more rows</div><div class='input'>
<span class='co'># with MCMC via Stan (slower):</span>
<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'>fit_vb</span>(<span class='no'>pop_samples</span>, <span class='kw'>method</span> <span class='kw'>=</span> <span class='st'>"mcmc"</span>,
  <span class='kw'>chains</span> <span class='kw'>=</span> <span class='fl'>1</span>, <span class='kw'>iter</span> <span class='kw'>=</span> <span class='fl'>800</span>) <span class='co'># just for a fast example</span></div><div class='output co'>#&gt; 
#&gt; SAMPLING FOR MODEL 'vb' NOW (CHAIN 1).
#&gt; 
#&gt; Gradient evaluation took 0.000315 seconds
#&gt; 1000 transitions using 10 leapfrog steps per transition would take 3.15 seconds.
#&gt; Adjust your expectations accordingly!
#&gt; 
#&gt; 
#&gt; Iteration:   1 / 800 [  0%]  (Warmup)
#&gt; Iteration:  80 / 800 [ 10%]  (Warmup)
#&gt; Iteration: 160 / 800 [ 20%]  (Warmup)
#&gt; Iteration: 240 / 800 [ 30%]  (Warmup)
#&gt; Iteration: 320 / 800 [ 40%]  (Warmup)
#&gt; Iteration: 400 / 800 [ 50%]  (Warmup)
#&gt; Iteration: 401 / 800 [ 50%]  (Sampling)
#&gt; Iteration: 480 / 800 [ 60%]  (Sampling)
#&gt; Iteration: 560 / 800 [ 70%]  (Sampling)
#&gt; Iteration: 640 / 800 [ 80%]  (Sampling)
#&gt; Iteration: 720 / 800 [ 90%]  (Sampling)
#&gt; Iteration: 800 / 800 [100%]  (Sampling)
#&gt; 
#&gt;  Elapsed Time: 0.893138 seconds (Warm-up)
#&gt;                0.697525 seconds (Sampling)
#&gt;                1.59066 seconds (Total)
#&gt; </div><div class='input'><span class='no'>x</span>$<span class='no'>pars</span></div><div class='output co'>#&gt; $k
#&gt; [1] 0.1624545
#&gt; 
#&gt; $linf
#&gt; [1] 43.44004
#&gt; 
#&gt; $sigma
#&gt; [1] 0.07106274
#&gt; 
#&gt; $t0
#&gt; [1] -0.6539176
#&gt; 
#&gt; $lp__
#&gt; [1] 3093.782
#&gt; </div><div class='input'><span class='no'>x</span>$<span class='no'>predictions</span></div><div class='output co'>#&gt; # A tibble: 200 x 2
#&gt;      age length
#&gt;    &lt;dbl&gt;  &lt;dbl&gt;
#&gt;  1  2      15.2
#&gt;  2  2.35   16.8
#&gt;  3  2.70   18.3
#&gt;  4  3.06   19.7
#&gt;  5  3.41   21.0
#&gt;  6  3.76   22.2
#&gt;  7  4.11   23.4
#&gt;  8  4.46   24.5
#&gt;  9  4.81   25.6
#&gt; 10  5.17   26.6
#&gt; # ... with 190 more rows</div><div class='input'><span class='no'>x</span>$<span class='no'>data</span></div><div class='output co'>#&gt; # A tibble: 1,444 x 34
#&gt;    trip_start_date      year month  gear survey_series_id survey_abbrev
#&gt;    &lt;dttm&gt;              &lt;int&gt; &lt;int&gt; &lt;dbl&gt;            &lt;dbl&gt; &lt;chr&gt;        
#&gt;  1 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  2 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  3 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  4 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  5 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  6 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  7 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  8 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt;  9 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt; 10 2011-07-05 00:00:00  2011     7     1                1 SYN QCS      
#&gt; # ... with 1,434 more rows, and 28 more variables: survey_series_desc &lt;chr&gt;,
#&gt; #   survey_id &lt;int&gt;, major_stat_area_code &lt;chr&gt;, major_stat_area_name &lt;chr&gt;,
#&gt; #   minor_stat_area_code &lt;chr&gt;, species_code &lt;chr&gt;, species_common_name &lt;chr&gt;,
#&gt; #   species_science_name &lt;chr&gt;, specimen_id &lt;dbl&gt;, sample_id &lt;dbl&gt;, sex &lt;dbl&gt;,
#&gt; #   age &lt;dbl&gt;, sampling_desc &lt;chr&gt;, ageing_method &lt;dbl&gt;, length &lt;dbl&gt;,
#&gt; #   weight &lt;int&gt;, maturity_code &lt;dbl&gt;, maturity_name &lt;chr&gt;,
#&gt; #   maturity_desc &lt;chr&gt;, maturity_convention_code &lt;dbl&gt;,
#&gt; #   maturity_convention_desc &lt;chr&gt;, maturity_convention_maxvalue &lt;dbl&gt;,
#&gt; #   trip_sub_type_code &lt;dbl&gt;, sample_type_code &lt;dbl&gt;,
#&gt; #   species_category_code &lt;dbl&gt;, sample_source_code &lt;dbl&gt;,
#&gt; #   usability_code &lt;dbl&gt;, grouping_code &lt;dbl&gt;</div><div class='input'><span class='no'>x</span>$<span class='no'>model</span></div><div class='output co'>#&gt; Inference for Stan model: vb.
#&gt; 1 chains, each with iter=800; warmup=400; thin=1; 
#&gt; post-warmup draws per chain=400, total post-warmup draws=400.
#&gt; 
#&gt;          mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
#&gt; k        0.16    0.00 0.00    0.16    0.16    0.16    0.16    0.17   160    1
#&gt; linf    43.43    0.01 0.13   43.19   43.34   43.44   43.52   43.67   240    1
#&gt; sigma    0.07    0.00 0.00    0.07    0.07    0.07    0.07    0.07   321    1
#&gt; t0      -0.65    0.01 0.10   -0.83   -0.72   -0.65   -0.57   -0.46   174    1
#&gt; lp__  3093.47    0.09 1.32 3089.88 3092.77 3093.78 3094.40 3095.11   198    1
#&gt; 
#&gt; Samples were drawn using NUTS(diag_e) at Thu May 10 11:24:41 2018.
#&gt; For each parameter, n_eff is a crude measure of effective sample size,
#&gt; and Rhat is the potential scale reduction factor on split chains (at 
#&gt; convergence, Rhat=1).</div><div class='input'><span class='no'>posterior</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>rstan</span><span class='kw ns'>::</span><span class='fu'><a href='http://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract'>extract</a></span>(<span class='no'>x</span>$<span class='no'>model</span>)
<span class='fu'>hist</span>(<span class='no'>posterior</span>$<span class='no'>linf</span>)</div><div class='img'><img src='fit_vb-2.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'># If less than `min_samples`, fit_vb() returns an empty object that</span>
<span class='co'># plot_vb() will correctly parse and produce an empty plot:</span>
<span class='no'>obj</span> <span class='kw'>&lt;-</span> <span class='fu'>fit_vb</span>(<span class='no'>pop_samples</span>[<span class='fl'>1</span>:<span class='fl'>2</span>,])
<span class='fu'><a href='plot_growth.html'>plot_vb</a></span>(<span class='no'>obj</span>, <span class='no'>obj</span>)</div><div class='img'><img src='fit_vb-3.png' alt='' width='700' height='433' /></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#details">Details</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Sean Anderson, Elise Keppel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  

  </body>
</html>

